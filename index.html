<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinSight AI 智能投研终端 (MVP Demo)</title>
    
    <!-- React 全家桶 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 样式与图标 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; }
        pre, code { font-family: 'JetBrains Mono', monospace; }
        
        /* 动画定义 */
        .animate-enter { animation: enter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes enter { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .thinking-dot { animation: thinking 1.4s infinite ease-in-out both; }
        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes thinking { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* 自定义滚动条 */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }

        /* Markdown 样式模拟 */
        .prose p { margin-bottom: 0.75em; }
        .prose strong { color: #0f172a; font-weight: 600; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.75em; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // 1. 数据剧本 (Scenarios) - 对应 MCP_product.md
        // ==========================================
        const SCENARIOS = {
            'spread': {
                id: 'spread',
                title: 'RB vs I 黑色系联动',
                icon: 'fa-link',
                color: 'blue',
                desc: '分析螺纹钢与铁矿石的价差回归机会',
                query: "获取过去3年螺纹钢(RB)和铁矿石(I)的主力合约收盘价，计算它们的相关性系数，并绘制价差序列图。",
                steps: [
                    { status: 'done', text: '语义解析: 识别到 "螺纹钢" -> KQ.m@SHFE.rb, "铁矿石" -> KQ.m@DCE.i' },
                    { status: 'done', text: 'MCP 调用: tq_get_kline(symbol="KQ.m@SHFE.rb", duration=86400)' },
                    { status: 'done', text: 'MCP 调用: tq_get_kline(symbol="KQ.m@DCE.i", duration=86400)' },
                    { status: 'done', text: 'Python 执行: 数据清洗与相关性计算...' }
                ],
                summary: `分析完成。
- **相关性**: 螺纹钢与铁矿石的相关系数为 **0.85**，呈现高度正相关。
- **价差状态**: 当前价差比值处于历史 **90% 分位**，属于高估区间。
- **建议**: 关注多铁矿、空螺纹的套利机会（回归策略）。`,
                pythonCode: `# 1. Load Data from MCP Tools
df_rb = pd.read_csv(io.StringIO(res_rb))
df_i = pd.read_csv(io.StringIO(res_i))

# 2. Merge Data
df = pd.merge(df_rb, df_i, on='datetime', suffixes=('_rb', '_i'))

# 3. Calculate Spread & Correlation
correlation = df['close_rb'].corr(df['close_i'])
df['spread'] = df['close_rb'] - df['close_i'] * 1.6 # 假设比率
df['z_score'] = (df['spread'] - df['spread'].mean()) / df['spread'].std()

# 4. Plotting (handled by frontend engine)`,
                chartConfig: (ctx) => ({
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'],
                        datasets: [
                            {
                                label: '价差 Z-Score',
                                data: [0.5, 0.8, 1.2, 1.5, 0.2, -0.5, -1.2, -0.8, 1.8, 2.1],
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 2
                            },
                            {
                                label: '上轨 (+2std)',
                                data: [2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
                                borderColor: '#ef4444',
                                borderDash: [5, 5],
                                borderWidth: 1,
                                pointRadius: 0
                            },
                            {
                                label: '下轨 (-2std)',
                                data: [-2, -2, -2, -2, -2, -2, -2, -2, -2, -2],
                                borderColor: '#10b981',
                                borderDash: [5, 5],
                                borderWidth: 1,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        plugins: { 
                            title: { display: true, text: 'RB/I 价差标准分序列 (Z-Score)' },
                            legend: { position: 'bottom' }
                        },
                        scales: { y: { grid: { borderDash: [2, 2] } } }
                    }
                })
            },
            'arbitrage': {
                id: 'arbitrage',
                title: '玻璃跨期套利',
                icon: 'fa-scale-balanced',
                color: 'purple',
                desc: 'FG2501 vs FG2505 价差分布统计',
                query: "获取玻璃期货主力(2501)与次主力(2505)的价差数据，统计价差分布直方图。",
                steps: [
                    { status: 'done', text: '语义解析: 玻璃 -> CZCE.FG; 2501 -> CZCE.FG501, 2505 -> CZCE.FG505' },
                    { status: 'done', text: 'MCP 调用: tq_get_quote("CZCE.FG501") // 获取乘数' },
                    { status: 'done', text: 'MCP 调用: tq_get_kline("CZCE.FG501", ...)' },
                    { status: 'done', text: 'MCP 调用: tq_get_kline("CZCE.FG505", ...)' }
                ],
                summary: `**玻璃跨期价差分布报告**
- **均值**: 125 元/吨
- **标准差**: 45 元
- **当前状态**: 价差 **80** 元，位于 -1 标准差附近，属于偏低区域。
- **历史概率**: 历史上价差低于 80 元的概率仅为 **15%**。`,
                pythonCode: `# 1. Calculate Spread
df['spread'] = df['close_01'] - df['close_05']

# 2. Stats
mean_val = df['spread'].mean()
std_val = df['spread'].std()

# 3. Distribution Analysis
hist_data = np.histogram(df['spread'], bins=20)`,
                chartConfig: (ctx) => ({
                    type: 'bar',
                    data: {
                        labels: ['<0', '0-50', '50-100', '100-150', '150-200', '200-250', '>250'],
                        datasets: [{
                            label: '频数分布',
                            data: [5, 15, 45, 80, 50, 20, 5],
                            backgroundColor: (c) => {
                                const idx = c.dataIndex;
                                return idx === 2 ? '#ec4899' : 'rgba(147, 51, 234, 0.5)'; // Highlight current
                            },
                            borderRadius: 4
                        }]
                    },
                    options: {
                        plugins: {
                            title: { display: true, text: 'FG01-05 价差正态分布' },
                            annotation: {
                                annotations: {
                                    line1: { type: 'line', xMin: 2, xMax: 2, borderColor: 'red', borderWidth: 2, label: { content: '当前价差', enabled: true } }
                                }
                            }
                        }
                    }
                })
            },
            'technical': {
                id: 'technical',
                title: '均线支撑验证',
                icon: 'fa-crosshairs',
                color: 'amber',
                desc: '统计螺纹钢回踩 MA20 不破的成功率',
                query: "分析螺纹钢主力合约，统计回踩 MA20 且未跌破的次数及后续涨幅。",
                steps: [
                    { status: 'done', text: '语义解析: 螺纹钢 -> KQ.m@SHFE.rb' },
                    { status: 'done', text: 'MCP 调用: tq_get_kline("KQ.m@SHFE.rb", duration=86400, length=300)' },
                    { status: 'done', text: 'Python 执行: MA20 计算与信号筛选...' }
                ],
                summary: `**技术指标回测报告**
- **有效支撑次数**: 8 次
- **平均后续涨幅**: +1.8% (3日内)
- **胜率**: 75%
- **结论**: 螺纹钢在多头趋势中，MA20 是一条具有高统计学意义的支撑线，适合作为低吸点位。`,
                pythonCode: `# 1. Calculate MA
df['ma20'] = df['close'].rolling(20).mean()

# 2. Signal: Low <= MA20 <= Close (Touch & Rebound)
cond = (df['low'] <= df['ma20']) & (df['close'] > df['ma20'])
signals = df[cond]

# 3. Forward Returns
signals['fwd_ret'] = df['close'].shift(-3) / df['close'] - 1`,
                chartConfig: (ctx) => ({
                    type: 'line',
                    data: {
                        labels: ['T-40', 'T-35', 'T-30', 'T-25', 'T-20', 'T-15', 'T-10', 'T-5', 'Now'],
                        datasets: [
                            {
                                label: '收盘价',
                                data: [3600, 3650, 3620, 3680, 3750, 3720, 3800, 3850, 3820],
                                borderColor: '#94a3b8',
                                borderWidth: 1,
                                pointRadius: 0
                            },
                            {
                                label: 'MA20',
                                data: [3580, 3600, 3610, 3640, 3680, 3710, 3750, 3780, 3800],
                                borderColor: '#f59e0b',
                                borderWidth: 2,
                                pointRadius: 0
                            },
                            {
                                label: '有效支撑信号',
                                type: 'scatter',
                                data: [
                                    {x: 'T-30', y: 3620},
                                    {x: 'T-15', y: 3720}
                                ],
                                backgroundColor: '#ef4444',
                                pointRadius: 6,
                                pointHoverRadius: 8
                            }
                        ]
                    },
                    options: {
                        plugins: { title: { display: true, text: 'RB 主力日线图 (MA20 策略)' } }
                    }
                })
            },
            'seasonality': {
                id: 'seasonality',
                title: '纯碱季节性',
                icon: 'fa-calendar-alt',
                color: 'cyan',
                desc: 'SA 月度涨跌幅热力统计',
                query: "绘制纯碱期货(SA)的月度季节性走势热力图。",
                steps: [
                    { status: 'done', text: '语义解析: 纯碱 -> KQ.m@CZCE.SA' },
                    { status: 'done', text: 'MCP 调用: tq_get_kline("KQ.m@CZCE.SA", duration=86400, length=1000)' },
                    { status: 'done', text: 'Python 执行: GroupBy Month 聚合统计...' }
                ],
                summary: `**纯碱季节性规律**
- **强势月份**: 9月 (平均涨幅 +5.2%)、8月 (+2.1%)
- **弱势月份**: 6月 (-3.2%)、3月 (-2.1%)
- **规律**: 纯碱呈现明显的“金九银十”特征，建议重点关注 8 月底的季节性做多机会。`,
                pythonCode: `# 1. Extract Month
df['month'] = pd.to_datetime(df['datetime']).dt.month

# 2. Group Stats
monthly_ret = df.groupby('month')['pct_chg'].mean()
win_rate = df.groupby('month')['is_up'].mean()`,
                chartConfig: (ctx) => ({
                    type: 'bar',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                        datasets: [{
                            label: '月度平均涨幅 (%)',
                            data: [1.2, -0.5, -2.1, 0.8, 1.5, -3.2, 0.5, 2.1, 5.2, 3.8, 1.1, -0.9],
                            backgroundColor: (c) => {
                                const val = c.raw;
                                return val >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)';
                            },
                            borderRadius: 4
                        }]
                    },
                    options: {
                        plugins: { title: { display: true, text: '纯碱期货月度平均涨幅统计 (2020-2024)' } }
                    }
                })
            }
        };

        // ==========================================
        // 2. 组件：代码/JSON 查看器
        // ==========================================
        const CodeBlock = ({ code, language = 'python' }) => (
            <div className="bg-[#1e293b] rounded-lg overflow-hidden border border-gray-700 font-mono text-xs">
                <div className="flex items-center justify-between px-3 py-2 bg-[#0f172a] border-b border-gray-700">
                    <span className="text-gray-400">{language}</span>
                    <button className="text-gray-500 hover:text-white transition-colors"><i className="far fa-copy"></i></button>
                </div>
                <div className="p-3 overflow-x-auto text-gray-300 whitespace-pre">
                    {code}
                </div>
            </div>
        );

        // ==========================================
        // 3. 组件：思考过程展示 (Thinking Process)
        // ==========================================
        const ThinkingProcess = ({ steps, isComplete }) => {
            const [expanded, setExpanded] = useState(true);
            
            return (
                <div className="mb-4 border border-blue-100 bg-blue-50/50 rounded-xl overflow-hidden">
                    <div 
                        className="flex items-center justify-between px-4 py-2 cursor-pointer hover:bg-blue-100/50 transition-colors"
                        onClick={() => setExpanded(!expanded)}
                    >
                        <div className="flex items-center gap-2 text-sm text-blue-700 font-medium">
                            {isComplete ? <i className="fas fa-check-circle text-green-500"></i> : <i className="fas fa-circle-notch fa-spin"></i>}
                            <span>{isComplete ? '已完成处理' : 'AI 正在思考...'}</span>
                        </div>
                        <i className={`fas fa-chevron-down text-blue-400 transition-transform ${expanded ? 'rotate-180' : ''}`}></i>
                    </div>
                    
                    {expanded && (
                        <div className="px-4 py-3 bg-white space-y-3">
                            {steps.map((step, idx) => (
                                <div key={idx} className="flex gap-3 text-xs animate-enter" style={{animationDelay: `${idx * 0.1}s`}}>
                                    <div className="flex flex-col items-center">
                                        <div className={`w-2 h-2 rounded-full mt-1.5 ${step.status === 'done' ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                                        {idx !== steps.length - 1 && <div className="w-px h-full bg-gray-200 my-0.5"></div>}
                                    </div>
                                    <div className={`${step.status === 'done' ? 'text-gray-700' : 'text-gray-400'}`}>
                                        <span className="font-bold mr-1">[{step.text.split(':')[0]}]</span>
                                        <span className="font-mono bg-gray-50 px-1 rounded text-gray-500">{step.text.split(':')[1]}</span>
                                    </div>
                                </div>
                            ))}
                            {!isComplete && (
                                <div className="flex gap-3 text-xs opacity-50">
                                    <div className="w-2 h-2 rounded-full bg-blue-400 animate-pulse mt-1.5 ml-0"></div>
                                    <span className="text-gray-500 italic">Processing next step...</span>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // 4. 组件：图表 Canvas
        // ==========================================
        const ChartView = ({ config }) => {
            const canvasRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || !config) return;
                
                if (chartInstance.current) chartInstance.current.destroy();

                const ctx = canvasRef.current.getContext('2d');
                const finalConfig = typeof config === 'function' ? config(ctx) : config;

                chartInstance.current = new Chart(ctx, {
                    ...finalConfig,
                    options: {
                        ...finalConfig.options,
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                    }
                });

                return () => chartInstance.current?.destroy();
            }, [config]);

            return <canvas ref={canvasRef} />;
        };

        // ==========================================
        // 5. 主应用 (FinSight Terminal)
        // ==========================================
        const App = () => {
            const [input, setInput] = useState('');
            const [chatHistory, setChatHistory] = useState([]); // { role, content, steps?, scenario? }
            const [currentArtifact, setCurrentArtifact] = useState(null); // The right side content
            const [isTyping, setIsTyping] = useState(false);
            const [activeTab, setActiveTab] = useState('chart'); // chart | data | code

            const chatEndRef = useRef(null);
            
            useEffect(() => chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }), [chatHistory, isTyping]);

            const handleSend = async (text = input) => {
                if (!text.trim()) return;
                
                // 1. User Message
                const userMsg = { role: 'user', content: text };
                setChatHistory(prev => [...prev, userMsg]);
                setInput('');
                setIsTyping(true);

                // 2. Find matching scenario (Mock AI Router)
                const scenarioKey = Object.keys(SCENARIOS).find(k => SCENARIOS[k].query.includes(text.substring(0, 5))) || 'spread';
                const scenario = SCENARIOS[scenarioKey];

                // 3. Simulate Thinking Steps
                let currentSteps = [];
                const addStep = (step) => {
                    currentSteps = [...currentSteps, step];
                    // Create a temporary AI message to show progress
                    setChatHistory(prev => {
                        const newHistory = [...prev];
                        if (newHistory[newHistory.length - 1].role === 'ai' && newHistory[newHistory.length - 1].isProgress) {
                            newHistory[newHistory.length - 1] = { role: 'ai', isProgress: true, steps: currentSteps };
                        } else {
                            newHistory.push({ role: 'ai', isProgress: true, steps: currentSteps });
                        }
                        return newHistory;
                    });
                };

                // Sequence simulation
                await new Promise(r => setTimeout(r, 800));
                addStep(scenario.steps[0]); // Semantic
                
                await new Promise(r => setTimeout(r, 1200));
                addStep(scenario.steps[1]); // MCP Call 1
                
                if (scenario.steps[2]) {
                    await new Promise(r => setTimeout(r, 1000));
                    addStep(scenario.steps[2]); // MCP Call 2
                }
                
                await new Promise(r => setTimeout(r, 1500));
                addStep(scenario.steps[scenario.steps.length - 1]); // Python Exec

                // 4. Final Result
                await new Promise(r => setTimeout(r, 500));
                setChatHistory(prev => {
                    const final = prev.filter(m => !m.isProgress); // Remove progress msg
                    return [...final, { 
                        role: 'ai', 
                        content: scenario.summary, 
                        steps: scenario.steps,
                        scenarioId: scenario.id 
                    }];
                });
                
                setCurrentArtifact(scenario);
                setIsTyping(false);
            };

            return (
                <div className="flex h-screen w-full overflow-hidden">
                    
                    {/* LEFT: Chat Area */}
                    <div className="flex flex-col w-full md:w-[450px] bg-white border-r border-gray-200 z-10 shadow-xl">
                        {/* Header */}
                        <div className="h-14 border-b border-gray-100 flex items-center px-4 justify-between bg-white flex-shrink-0">
                            <div className="flex items-center gap-2">
                                <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                                    <i className="fas fa-layer-group"></i>
                                </div>
                                <span className="font-bold text-gray-800">FinSight AI</span>
                            </div>
                            <button onClick={() => {setChatHistory([]); setCurrentArtifact(null);}} className="text-gray-400 hover:text-gray-600" title="New Chat">
                                <i className="fas fa-plus"></i>
                            </button>
                        </div>

                        {/* Messages */}
                        <div className="flex-1 overflow-y-auto custom-scroll p-4 bg-gray-50/30">
                            {chatHistory.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-center p-6 opacity-0 animate-enter" style={{animationDelay: '0.2s'}}>
                                    <div className="mb-8">
                                        <h1 className="text-2xl font-bold text-gray-800 mb-2">有什么交易想法？</h1>
                                        <p className="text-sm text-gray-500">FinSight 帮你用历史数据验证每一个直觉。</p>
                                    </div>
                                    <div className="grid gap-3 w-full">
                                        {Object.values(SCENARIOS).map(sc => (
                                            <button 
                                                key={sc.id}
                                                onClick={() => handleSend(sc.query)}
                                                className="group text-left p-4 bg-white border border-gray-200 rounded-xl hover:border-blue-300 hover:shadow-md transition-all flex items-start gap-3"
                                            >
                                                <div className={`w-8 h-8 rounded-full bg-${sc.color}-100 text-${sc.color}-600 flex items-center justify-center flex-shrink-0`}>
                                                    <i className={`fas ${sc.icon}`}></i>
                                                </div>
                                                <div>
                                                    <div className="font-medium text-gray-700 group-hover:text-blue-600 transition-colors">{sc.title}</div>
                                                    <div className="text-xs text-gray-400 mt-1 line-clamp-2">{sc.desc}</div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    {chatHistory.map((msg, idx) => (
                                        <div key={idx} className={`flex gap-3 ${msg.role === 'user' ? 'flex-row-reverse' : ''} animate-enter`}>
                                            <div className={`w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-xs ${msg.role === 'ai' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>
                                                <i className={`fas fa-${msg.role === 'ai' ? 'robot' : 'user'}`}></i>
                                            </div>
                                            <div className={`flex flex-col max-w-[85%] ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                                {/* Thinking Process for AI */}
                                                {msg.role === 'ai' && (msg.steps || msg.isProgress) && (
                                                    <div className="w-full">
                                                        <ThinkingProcess steps={msg.steps || []} isComplete={!msg.isProgress} />
                                                    </div>
                                                )}
                                                
                                                {/* Message Content */}
                                                {!msg.isProgress && (
                                                    <div className={`p-3.5 rounded-2xl text-sm leading-relaxed shadow-sm ${
                                                        msg.role === 'ai' 
                                                        ? 'bg-white border border-gray-100 text-gray-800 rounded-tl-none prose' 
                                                        : 'bg-blue-600 text-white rounded-tr-none'
                                                    }`}>
                                                        <div dangerouslySetInnerHTML={{ __html: msg.content.replace(/\n/g, '<br/>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }} />
                                                    </div>
                                                )}

                                                {/* Artifact Link Button (if scenario attached) */}
                                                {msg.scenarioId && (
                                                    <button 
                                                        onClick={() => setCurrentArtifact(SCENARIOS[msg.scenarioId])}
                                                        className="mt-2 text-xs flex items-center gap-1.5 text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors"
                                                    >
                                                        <i className="fas fa-chart-simple"></i> 查看分析详情
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {isTyping && !chatHistory[chatHistory.length - 1]?.isProgress && (
                                        <div className="flex gap-1 ml-11 py-2">
                                            <div className="w-2 h-2 bg-gray-300 rounded-full thinking-dot"></div>
                                            <div className="w-2 h-2 bg-gray-300 rounded-full thinking-dot"></div>
                                            <div className="w-2 h-2 bg-gray-300 rounded-full thinking-dot"></div>
                                        </div>
                                    )}
                                    <div ref={chatEndRef} />
                                </div>
                            )}
                        </div>

                        {/* Input Area */}
                        <div className="p-4 border-t border-gray-100 bg-white">
                            <div className="relative">
                                <input 
                                    type="text" 
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                                    placeholder="输入指令..."
                                    className="w-full pl-4 pr-12 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all text-sm"
                                    disabled={isTyping}
                                />
                                <button 
                                    onClick={() => handleSend()}
                                    disabled={!input.trim() || isTyping}
                                    className="absolute right-2 top-2 w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                >
                                    <i className="fas fa-arrow-up text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* RIGHT: Artifact Area (Canvas) */}
                    <main className="flex-1 bg-gray-50 flex flex-col relative overflow-hidden">
                        {currentArtifact ? (
                            <div className="absolute inset-0 flex flex-col animate-enter">
                                {/* Toolbar */}
                                <div className="h-14 bg-white border-b border-gray-200 flex items-center justify-between px-6 flex-shrink-0">
                                    <h2 className="font-bold text-gray-700 truncate max-w-md flex items-center gap-2">
                                        <div className={`w-2 h-2 rounded-full bg-${currentArtifact.color}-500`}></div>
                                        {currentArtifact.title}
                                    </h2>
                                    <div className="flex bg-gray-100 p-1 rounded-lg">
                                        {['chart', 'code'].map(tab => (
                                            <button
                                                key={tab}
                                                onClick={() => setActiveTab(tab)}
                                                className={`px-3 py-1.5 text-xs font-medium rounded-md transition-all capitalize ${
                                                    activeTab === tab ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'
                                                }`}
                                            >
                                                {tab === 'chart' ? '可视化图表' : 'Python 代码'}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Content */}
                                <div className="flex-1 overflow-y-auto p-6 custom-scroll">
                                    {activeTab === 'chart' ? (
                                        <div className="h-full flex flex-col gap-6">
                                            {/* Chart Container */}
                                            <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 h-[400px] flex-shrink-0">
                                                <ChartView config={currentArtifact.chartConfig} />
                                            </div>
                                            
                                            {/* Metrics Cards */}
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                                    <div className="text-xs text-gray-400 font-mono mb-1">DATA SOURCE</div>
                                                    <div className="text-sm font-semibold flex items-center gap-2">
                                                        <i className="fas fa-database text-gray-400"></i>
                                                        FinSight MCP
                                                    </div>
                                                </div>
                                                <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                                    <div className="text-xs text-gray-400 font-mono mb-1">EXECUTION TIME</div>
                                                    <div className="text-sm font-semibold">1.24s</div>
                                                </div>
                                                <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                                    <div className="text-xs text-gray-400 font-mono mb-1">MODEL</div>
                                                    <div className="text-sm font-semibold text-green-600">
                                                        <i className="fas fa-check-circle mr-1"></i>
                                                        Auto-Verified
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Detailed Summary */}
                                            <div className="bg-indigo-50/50 border border-indigo-100 rounded-xl p-5">
                                                <h4 className="text-indigo-900 font-bold mb-2 flex items-center gap-2">
                                                    <i className="fas fa-lightbulb text-yellow-500"></i>
                                                    深度洞察
                                                </h4>
                                                <div className="prose prose-sm max-w-none text-indigo-900/80" dangerouslySetInnerHTML={{ __html: currentArtifact.summary.replace(/\n/g, '<br/>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }}></div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="h-full">
                                            <CodeBlock code={currentArtifact.pythonCode} />
                                            <div className="mt-4 p-4 bg-yellow-50 border border-yellow-100 rounded-xl text-xs text-yellow-800 flex gap-3">
                                                <i className="fas fa-exclamation-triangle mt-0.5"></i>
                                                <div>
                                                    <p className="font-bold mb-1">免责声明</p>
                                                    <p>此代码由 AI 生成并在沙箱环境中执行。过往业绩不代表未来收益，请务必核对逻辑后再用于实盘交易。</p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-300">
                                <i className="fas fa-chart-pie text-6xl mb-4 opacity-50"></i>
                                <p className="text-lg font-medium">在左侧开始对话以生成分析</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>